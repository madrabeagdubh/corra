<DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Corra</title>
  <link rel="stylesheet" href="css/styles.css">

  <style>
    html {
      background: #02040a;
    }

    body {
      margin: 0;
      padding: 0;
      background: transparent;
      min-height: 100vh;
    }

    #starfieldLoader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #02040a;
      z-index: 1;
      pointer-events: none;
    }

    #starfieldCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .loading-text {
      position: relative;
      z-index: 1;
      margin-top: 40px;
      color: #e0e0e0;
      font-family: monospace;
      font-size: 20px;
      letter-spacing: 3px;
      animation: fadeInOut 2s ease-in-out infinite;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body>
	<div style="font-family: 'Aonchlo'; visibility: hidden; position: absolute;">
		</div>
  <div id="starfieldLoader">
    <canvas id="starfieldCanvas"></canvas>
  </div>

  <script type="module">
    // Starfield loader implementation
    let canvas, ctx, animationId;
    let active = true; // CRITICAL: start as true so animation runs
    let stars = [];
    let lastTime = 0;
    const nebulaImage = new Image();

    const STAR_COUNT = 350;
    nebulaImage.src = 'assets/n1-top@3x.png';

    class Star {
      constructor(w, h, hubX, hubY) {
        this.hubX = hubX;
        this.hubY = hubY;
        this.reset(w, h);
      }

      reset(w, h) {
        const maxScreenDist = Math.sqrt(w * w + h * h);
        this.dist = Math.random() * maxScreenDist;
        this.angle = Math.random() * Math.PI * 2;
        this.size = Math.random() * 1.4 + 0.2;
        this.rotationSpeed = (Math.random() * 0.00004 + 0.00001);
        this.opacity = Math.random() * 0.6 + 0.2;
        this.twinkleSpeed = Math.random() * 0.002 + 0.001;
      }

      update(delta) {
        this.angle += this.rotationSpeed * delta;
      }

      draw(ctx, now) {
        const x = this.hubX + Math.cos(this.angle) * this.dist;
        const y = this.hubY + Math.sin(this.angle) * this.dist;
        const currentOpacity = this.opacity + Math.sin(now * this.twinkleSpeed) * 0.2;

        ctx.fillStyle = `rgba(255, 255, 255, ${Math.max(0, currentOpacity)})`;
        ctx.beginPath();
        ctx.arc(x, y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function initStarfield() {
      console.log('[Starfield] initStarfield called');
      active = true;
      lastTime = performance.now();

      canvas = document.getElementById('starfieldCanvas');
      if (!canvas) {
        console.error('[Starfield] ERROR: Canvas element not found!');
        return;
      }
      console.log('[Starfield] Canvas element found:', canvas);
      
      ctx = canvas.getContext('2d');
      console.log('[Starfield] Canvas context created:', ctx);

      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      console.log('[Starfield] Canvas dimensions set to:', canvas.width, 'x', canvas.height);

      const hubX = canvas.width * 0.33;
      const hubY = canvas.height * 0.7;

      stars = Array.from({ length: STAR_COUNT }, () => new Star(canvas.width, canvas.height, hubX, hubY));
      console.log('[Starfield] Created', stars.length, 'stars');

      function animate(now) {
        if (!active) {
          console.warn('[Starfield] Animation stopped - active is false!');
          return;
        }
        const rawDelta = now - lastTime;
        // Cap delta to prevent huge jumps during loading
        const delta = Math.min(rawDelta, 100); // Max 100ms per frame
        lastTime = now;

        // Background
        ctx.fillStyle = '#02040a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Nebula
        if (nebulaImage.complete && nebulaImage.naturalWidth > 0) {
          ctx.save();
          ctx.translate(hubX, hubY);
          ctx.rotate(now * 0.00002);
          ctx.globalAlpha = 0.4 + (Math.sin(now * 0.0005) * 0.1);

          const scale = 2.2;
          const side = Math.max(canvas.width, canvas.height) * scale;
          ctx.drawImage(nebulaImage, -side/2, -side/2, side, side);
          ctx.restore();
        }

        // Stars
        stars.forEach(star => {
          star.update(delta);
          star.draw(ctx, now);
        });

        animationId = requestAnimationFrame(animate);
      }

      window.addEventListener('resize', resizeCanvas);
      console.log('[Starfield] Starting animation loop...');
      animationId = requestAnimationFrame(animate);
      
      // Verify animation is running
      setTimeout(() => {
        console.log('[Starfield] Status check - active:', active, 'animationId:', animationId, 'stars:', stars.length);
      }, 1000);
    }

    function stopStarfield() {
      active = false;
      if (animationId) cancelAnimationFrame(animationId);
      window.removeEventListener('resize', resizeCanvas);
    }

    function resizeCanvas() {
      if (!canvas) return;
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const hubX = canvas.width * 0.33;
      const hubY = canvas.height * 0.7;
      stars.forEach(s => {
        s.hubX = hubX;
        s.hubY = hubY;
      });
    }

    // Initialize starfield on load and let it run forever
    window.addEventListener('load', () => {
      initStarfield();
      console.log('[Starfield] Background starfield started - runs continuously');
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  <!--	<button id="startButton">Fadó fadó...</button> -->
  <div id="heroSelect"></div>
  <div id="gameContainer"></div>

  <!-- Main Game Script -->
  <script type="module" src="js/heroSelect.js"></script>
  <script type="module" src="js/main.js?v=7"></script>

  <script>
    // Handle start button: fullscreen, scroll, and remove button
    const startButton = document.getElementById('startButton');
    if (startButton) {
      startButton.addEventListener('pointerup', () => {
        const el = document.documentElement;
        try {
          if (el.requestFullscreen) el.requestFullscreen();
          else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        } catch (err) {}

        const container = document.getElementById('gameContainer');
        if (container) container.scrollIntoView({ behavior: 'smooth' });

        startButton.remove();
      }, { once: true });
    }

    // Resize game container on viewport changes
    function resizeGame() {
      const container = document.getElementById('gameContainer');
      if (container) container.style.height = window.innerHeight + 'px';
    }

    window.addEventListener('load', resizeGame);
    window.addEventListener('resize', resizeGame);
    window.addEventListener('orientationchange', resizeGame);
  </script>
</body>
</html>

